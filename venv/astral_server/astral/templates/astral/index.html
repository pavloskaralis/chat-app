<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Rooms</title>
</head>
<body>
    Chat Room Name<br>
    <input id="room-name-input" type="text" size="100"><br>
    Chat Room Password (leave blank for public)<br>
    <input id="room-password-input" type="text" size="100"><br>
    Your Display Name<br>
    <input id="room-display-input" type="text" size="100"><br>
    <input id="room-name-submit" type="button" value="Enter"><br>
   
    Click to Join Room <br>
    <script>

        const lobbySocket = new WebSocket(
            'ws://'
            + 'localhost:8000'
            + '/ws/astral/'
        );

        lobbySocket.onmessage = function(e) {
            console.log('received')
            const data = JSON.parse(e.data);
            console.log(data);
            //when socket returns a room name, force url change
            if(data.roomName && !data.request) {
                window.location.pathname = '/astral/' + data.roomHash + '/' + data.roomName + '/';
            }
            //when socket returns room list, generate room nodes
            if(data.rooms) {
                let rooms = Object.keys(data.rooms);
                for(let i = 0; i < rooms.length; i++){
                    let key = rooms[i];
                    let room = document.createElement('button');
                    let access = document.createElement('span');
                    let capacity = document.createElement('span');
                    let br = document.createElement('br');
                    room.textContent = data.rooms[key].roomName.replace(/_/g,' ');
                    access.textContent = data.rooms[key].roomAccess;
                    capacity.textContent = ' ' + data.rooms[key].roomCapacity + ' of 8';
                    room.onclick = ()=> {
                        lobbySocket.send(JSON.stringify({
                            'roomName': data.rooms[key].roomName,
                            'requestType': 'join'
                        }));
                        // window.location.pathname = '/astral/' + data.rooms[key].roomName + '/';
                    }
                    document.body.append(room);
                    document.body.append(access);
                    document.body.append(capacity);
                    document.body.append(br);
                }
            }
            // when socket requests a password, show password input
            if(data.request) { 
                if(data.request === 'private') {
                    let text = document.createElement('div');
                    let input = document.createElement('input');
                    let br = document.createElement('br');
                    let text2 = document.createElement('div');
                    let input2 = document.createElement('input');
                    let br2 = document.createElement('br');
                    let submit = document.createElement('input');

                    text.textContent = 'Enter Room Password'
                    input.setAttribute('type','text')
                    input.setAttribute('size','100')
                    input.setAttribute('id','password-request-input')

                    submit.setAttribute('type','button')
                    submit.setAttribute('size','100');
                    submit.setAttribute('id','private-request-submit')
                    submit.setAttribute('value','enter')

                    text2.textContent = 'Enter Display Name'
                    input2.setAttribute('type','text')
                    input2.setAttribute('size','100')
                    input2.setAttribute('id','display-request-input')

                    submit.onclick = () => {
                        if(input.value.match(/^[^\s](?!.*[\s]{2,})[a-zA-Z\d\s]+[^\s]$/)) {
                            lobbySocket.send(JSON.stringify({
                                'roomName': data.roomName,
                                'roomPassword': input.value,
                                'displayName': input2.value.replace(/\s/g,'_'),
                                'requestType': 'private',
                            }));
                        } else {
                            console.log({error: 'invalid characters'})
                        }
                    }

                    document.body.append(text)
                    document.body.append(input)
                    document.body.append(br)
                    document.body.append(text2)
                    document.body.append(input2)
                    document.body.append(br2)
                    document.body.append(submit)
                } else if (data.request === 'public') {
                    let text = document.createElement('div');
                    let input = document.createElement('input');
                    let br = document.createElement('br');
                    let submit = document.createElement('input');

                    text.textContent = 'Enter Display Name'
                    input.setAttribute('type','text')
                    input.setAttribute('size','100')
                    input.setAttribute('id','display-request-input')

                    submit.setAttribute('type','button')
                    submit.setAttribute('size','100');
                    submit.setAttribute('id','public-request-submit')
                    submit.setAttribute('value','enter')

                    submit.onclick = () => {
                        if(input.value.match(/^[^\s](?!.*[\s]{2,})[a-zA-Z\d\s]+[^\s]$/)) {
                            lobbySocket.send(JSON.stringify({
                                'roomName': data.roomName,
                                'displayName': input.value.replace(/\s/g,'_'),
                                'requestType': 'public',
                            }));
                        } else {
                            console.log({error: 'invalid characters'})
                        }
                    }


                    document.body.append(text)
                    document.body.append(input)
                    document.body.append(br)
                    document.body.append(submit)
                }
            }
        };


       lobbySocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('#room-name-input').focus();
        document.querySelector('#room-name-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#room-name-submit').click();
            }
        };

        document.querySelector('#room-name-submit').onclick = function(e) {
            var roomName = document.querySelector('#room-name-input').value;
            var roomPassword = document.querySelector('#room-password-input').value;
            var displayName = document.querySelector('#room-display-input').value;
            
            if(
                roomName.match(/^[^\s](?!.*[\s]{2,})[a-zA-Z\d\s]+[^\s]$/) &&
                displayName.match(/^[^\s](?!.*[\s]{2,})[a-zA-Z\d\s]+[^\s]$/) &&
                (!roomPassword || roomPassword.match(/^[^\s](?!.*[\s]{2,})[a-zA-Z\d\s]+[^\s]$/))
            ) {
                lobbySocket.send(JSON.stringify({
                    'roomName': roomName.replace(/\s/g,'_'),
                    'roomPassword': roomPassword, 
                    'displayName': displayName.replace(/\s/g,'_'), 
                    'requestType': 'start'
                }));
            } else {
                console.log({error: 'invalid characters'})
            }
        };
    </script>
</body>
</html>